if(!window.aiAssistantContentScriptInitialized){let c=function(e){try{chrome?.runtime?.id&&chrome?.runtime?.sendMessage?chrome.runtime.sendMessage(e).catch(n=>{console.warn("[ContentScript] Error sending message to extension:",n,"Message:",e),n.message?.includes("Extension context invalidated")&&d()}):console.warn("[ContentScript] chrome.runtime.sendMessage not available. Message not sent:",e)}catch(n){console.error("[ContentScript] Exception in sendMessageToExtension:",n,"Message:",e),n.message?.includes("Extension context invalidated")&&d()}},d=function(){console.log("[ContentScript] Extension context invalidated. Attempting to reconnect..."),s=!1,t<o?(t++,setTimeout(()=>{console.log(`[ContentScript] Reconnection attempt ${t}/${o}`),i()},2e3*t)):console.error("[ContentScript] Max reconnection attempts reached. Please refresh the page.")},i=function(){try{chrome?.runtime?.id&&chrome?.runtime?.sendMessage?chrome.runtime.sendMessage({action:"testConnection"}).then(e=>{e&&e.success?(s=!0,t=0,c({action:"contentScriptLoaded",url:window.location.href,title:document.title})):(console.warn("[ContentScript] Connection test to background script failed or no success response.",e),t<o&&(t++,setTimeout(i,2e3*t)))}).catch(e=>{console.warn("[ContentScript] Error sending testConnection to background script.",e),t<o?(t++,setTimeout(i,2e3*t)):console.error("[ContentScript] Max reconnection attempts reached. Please refresh the page.")}):(console.warn("[ContentScript] chrome.runtime.sendMessage not available for verifyExtensionConnection."),t<o&&(t++,setTimeout(i,2e3*t)))}catch(e){console.error("[ContentScript] Exception in verifyExtensionConnection. Likely not in extension context.",e),t<o&&(t++,setTimeout(i,2e3*t))}};window.aiAssistantContentScriptInitialized=!0;let l="",s=!1,t=0,o=5;document.addEventListener("selectionchange",()=>{try{let e=window.getSelection();e&&e.toString().trim()&&(l=e.toString().trim(),s&&c({action:"textSelected",text:l}))}catch(e){console.warn("[ContentScript] Error in selectionchange listener:",e)}}),document.addEventListener("keydown",e=>{try{if(e.ctrlKey&&e.shiftKey&&e.key==="X"){let n=window.getSelection();if(n&&n.toString().trim()){let r=n.toString().trim();c({action:"textSelected",text:r,insertImmediately:!0})}}}catch(n){console.warn("[ContentScript] Error in keydown listener (Ctrl+Shift+X):",n)}});try{chrome?.runtime?.onMessage?chrome.runtime.onMessage.addListener((e,n,r)=>{if(e.action==="testContentScript")r({success:!0,message:"Content script is working",url:window.location.href});else if(e.action==="captureSelection"){let a=window.getSelection();if(a&&a.toString().trim()){let u=a.toString().trim();c({action:"textSelected",text:u,insertImmediately:!0}),r({success:!0,text:u})}else r({success:!1,message:"No text selected"})}else e.action==="selectionCaptured"&&r({success:!0});return!0}):console.warn("[ContentScript] chrome.runtime.onMessage not available.")}catch(e){console.error("[ContentScript] Error setting up onMessage listener:",e)}setTimeout(()=>{try{i()}catch(e){console.error("[ContentScript] Error starting verifyExtensionConnection timeout:",e)}},1e3)}
