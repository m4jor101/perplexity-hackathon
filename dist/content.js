if(!window.aiAssistantContentScriptInitialized){let s=function(e){try{chrome?.runtime?.id&&chrome?.runtime?.sendMessage?chrome.runtime.sendMessage(e).catch(i=>{console.warn("[ContentScript] Error sending message to extension:",i,"Message:",e),i.message?.includes("Extension context invalidated")&&d()}):console.warn("[ContentScript] chrome.runtime.sendMessage not available. Message not sent:",e)}catch(i){console.error("[ContentScript] Exception in sendMessageToExtension:",i,"Message:",e),i.message?.includes("Extension context invalidated")&&d()}},d=function(){console.log("[ContentScript] Extension context invalidated. Attempting to reconnect..."),c=!1,t<n?(t++,setTimeout(()=>{console.log(`[ContentScript] Reconnection attempt ${t}/${n}`),o()},2e3*t)):console.error("[ContentScript] Max reconnection attempts reached. Please refresh the page.")},o=function(){try{chrome?.runtime?.id&&chrome?.runtime?.sendMessage?chrome.runtime.sendMessage({action:"testConnection"}).then(e=>{e&&e.success?(c=!0,t=0,s({action:"contentScriptLoaded",url:window.location.href,title:document.title})):(console.warn("[ContentScript] Connection test to background script failed or no success response.",e),t<n&&(t++,setTimeout(o,2e3*t)))}).catch(e=>{console.warn("[ContentScript] Error sending testConnection to background script.",e),t<n?(t++,setTimeout(o,2e3*t)):console.error("[ContentScript] Max reconnection attempts reached. Please refresh the page.")}):(console.warn("[ContentScript] chrome.runtime.sendMessage not available for verifyExtensionConnection."),t<n&&(t++,setTimeout(o,2e3*t)))}catch(e){console.error("[ContentScript] Exception in verifyExtensionConnection. Likely not in extension context.",e),t<n&&(t++,setTimeout(o,2e3*t))}};window.aiAssistantContentScriptInitialized=!0;let l="",c=!1,t=0,n=5;document.addEventListener("selectionchange",()=>{try{let e=window.getSelection();e&&e.toString().trim()&&(l=e.toString().trim(),c&&s({action:"textSelected",text:l}))}catch(e){console.warn("[ContentScript] Error in selectionchange listener:",e)}});try{chrome?.runtime?.onMessage?chrome.runtime.onMessage.addListener((e,i,r)=>{if(e.action==="testContentScript")r({success:!0,message:"Content script is working",url:window.location.href});else if(e.action==="captureSelection"){let a=window.getSelection();if(a&&a.toString().trim()){let u=a.toString().trim();s({action:"textSelected",text:u,insertImmediately:!0}),r({success:!0,text:u})}else r({success:!1,message:"No text selected"})}else e.action==="selectionCaptured"&&r({success:!0});return!0}):console.warn("[ContentScript] chrome.runtime.onMessage not available.")}catch(e){console.error("[ContentScript] Error setting up onMessage listener:",e)}setTimeout(()=>{try{o()}catch(e){console.error("[ContentScript] Error starting verifyExtensionConnection timeout:",e)}},1e3)}
